## 2024-05-23 - Path Traversal in Mesh Visualizer
**Vulnerability:** The endpoints `/api/load_mesh`, `/api/mesh_screenshot`, and `/api/mesh_interactive` accepted a `file_path` parameter from the user and passed it directly to `pyvista.read` or `mesh_visualizer.load_mesh` without validation. This allowed users to potentially read arbitrary files on the server (if they were valid mesh formats or if `pyvista` supported them) or cause denial of service by loading non-mesh files.
**Learning:** Even if a library like `pyvista` seems specialized for 3D data, it performs file I/O and thus requires strict path validation when dealing with user-supplied paths. The assumption that "only mesh files will load" is insufficient protection against path traversal.
**Prevention:** Always validate user-supplied file paths using a strict "allow-list" approach or by ensuring the path resolves to a subdirectory of a trusted root (using `pathlib.Path.is_relative_to` after `resolve()`) before passing it to any file opening function. I applied `validate_safe_path(CASE_ROOT, file_path)` to all affected endpoints.

## 2024-05-23 - Path Traversal in Case Creation
**Vulnerability:** The `/api/case/create` endpoint accepted a `caseName` parameter and used it to construct a path `Path(CASE_ROOT) / case_name` which was then passed to `CaseManager.create_case_structure`. The `CaseManager` resolved the path but did not check if it was within `CASE_ROOT`. This allowed users to create directories (and potentially files like `controlDict`) anywhere on the filesystem where the process had write permissions by using `../` in the case name.
**Learning:** Checking for "safe" paths must happen at the boundary (API endpoint) before business logic is invoked. Even "creation" logic can be a vector for traversal if it involves creating directories at user-controlled paths.
**Prevention:** Applied `validate_safe_path(CASE_ROOT, case_name)` in `api_create_case` before passing the path to the manager. This ensures the target path is strictly within the allowed `CASE_ROOT`.

## 2024-05-24 - Command Injection via Newline
**Vulnerability:** The `is_safe_command` function intended to sanitize shell input only checked for standard shell metacharacters like `;`, `&`, `|` but missed newline characters (`\n`, `\r`). This allowed attackers to bypass the check by injecting commands on a new line (e.g., `valid_command\nmalicious_command`).
**Learning:** Blacklists are notoriously difficult to get right for shell command validation because there are many ways to separate or execute commands (newlines, backticks, subshells). A "secure" function that is incomplete gives a false sense of security.
**Prevention:** Added `\n`, `\r`, `{`, `}`, `[`, `]` to the blacklist. However, the best prevention is to avoid constructing shell commands from strings entirely and instead use `subprocess.run` with a list of arguments where possible, or enforce a strict whitelist of allowed commands (which this app does partially via `openfoam_commands`).
