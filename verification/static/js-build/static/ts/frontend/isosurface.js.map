{"version":3,"sources":["../../../../ts/frontend/isosurface.ts"],"sourcesContent":["/**\n * Contour Visualization Module\n * Handles isosurface generation using PyVista, and 3D visualization using Trame\n * \n * When making changes to the frontend, always edit isosurface.ts and build isosurface.js using `npm run build`\n */\n\n// Type definitions\ninterface ContourOptions {\n    tutorial?: string | null;\n    caseDir?: string | { value: string } | null;\n    scalarField?: string;\n    numIsosurfaces?: number;\n    range?: [number, number];\n    vtkFilePath?: string | null;\n    showIsovalueWidget?: boolean;\n    isovalues?: number[];\n    colorMap?: string;\n}\n\ninterface ContourData {\n    tutorial: string;\n    caseDir: string;\n    scalarField: string;\n    numIsosurfaces: number;\n    timestamp: string;\n    vtkFilePath?: string;\n    colorMap?: string;\n}\n\n// Extend HTMLElement for custom properties\ninterface MyHTMLElement extends HTMLElement {\n    value: string;\n}\n\n// Assume global functions are declared elsewhere\ndeclare function showNotification(message: string, type?: string, duration?: number): void;\n\n// Global state\nlet currentContourData: ContourData | null = null;\nlet currentFieldStats: Record<string, any> | null = null;\n\n/**\n * Generate isosurface contours for the loaded mesh\n * @param options - Configuration options\n * @returns Promise that resolves when contours are generated\n */\nexport async function generateContours(options: ContourOptions = {}): Promise<void> {\n    const contourPlaceholder = document.getElementById('contourPlaceholder');\n    const contourViewer = document.getElementById('contourViewer');\n\n    // Default options\n    // Default options (don't default scalarField/numIsosurfaces yet, check DOM first)\n    const {\n        tutorial = null,\n        caseDir = null,\n        vtkFilePath = null\n    } = options;\n\n    let { scalarField, numIsosurfaces, colorMap } = options;\n\n    // UX: Loading state\n    const btn = document.getElementById(\"generateContoursBtn\") as HTMLButtonElement | null;\n    let originalText = \"\";\n\n    if (btn) {\n        originalText = btn.innerHTML;\n        btn.disabled = true;\n        btn.setAttribute(\"aria-busy\", \"true\");\n        btn.innerHTML = `<svg class=\"animate-spin h-4 w-4 inline-block mr-2 text-white\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\"><circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle><path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path></svg> Generating...`;\n    }\n\n    try {\n        // Show loading state\n        showLoadingState(contourViewer, 'Generating contours...');\n        contourPlaceholder?.classList.add('hidden');\n        contourViewer?.classList.remove('hidden');\n\n        // Resolve scalarField\n        if (scalarField === undefined) {\n            const scalarFieldSelect = document.getElementById('scalarField') as MyHTMLElement | null;\n            scalarField = scalarFieldSelect?.value || 'U_Magnitude';\n        }\n\n        // Resolve numIsosurfaces\n        if (numIsosurfaces === undefined) {\n            const numIsosurfacesInput = document.getElementById('numIsosurfaces') as MyHTMLElement | null;\n            numIsosurfaces = numIsosurfacesInput?.value ? parseInt(numIsosurfacesInput.value, 10) : 10;\n        }\n\n        // Resolve colorMap\n        if (colorMap === undefined) {\n            const colorMapSelect = document.getElementById('colorMap') as MyHTMLElement | null;\n            colorMap = colorMapSelect?.value || 'viridis';\n        }\n\n        // Get tutorial from select if not provided\n        const selectedTutorial: string = tutorial ?? getTutorialFromSelect() ?? '';\n        if (!selectedTutorial) {\n            throw new Error('Please select a tutorial first');\n        }\n\n        // Get case directory - handle both object and string cases\n        let selectedCaseDir = '';\n        if (caseDir && typeof caseDir === 'object' && 'value' in caseDir) {\n            selectedCaseDir = (caseDir as { value: string }).value || '';\n        } else if (typeof caseDir === 'string') {\n            selectedCaseDir = caseDir;\n        }\n\n        // Try to get from the input field if still not available\n        if (!selectedCaseDir) {\n            const caseDirInput = document.getElementById('caseDir') as MyHTMLElement | null;\n            if (caseDirInput) {\n                selectedCaseDir = caseDirInput.value || '';\n            }\n        }\n\n        if (!selectedCaseDir) {\n            throw new Error('Case directory not set. Please set it in the Setup page.');\n        }\n\n        selectedCaseDir = String(selectedCaseDir).trim();\n\n        // Get VTK file path if not provided\n        let selectedVtkFilePath = vtkFilePath;\n        if (!selectedVtkFilePath) {\n            const vtkFileSelect = document.getElementById('vtkFileSelect') as MyHTMLElement | null;\n            // Check custom input if select is empty or \"custom\"\n            const vtkFileBrowser = document.getElementById('vtkFileBrowser') as HTMLInputElement | null;\n\n            if (vtkFileBrowser && vtkFileBrowser.files && vtkFileBrowser.files.length > 0) {\n                // For browser upload, we might handle it differently, but for now lets assume local path logic isn't used here \n                // actually standard vtkFileSelect is what we use for server-side files\n            }\n\n            if (vtkFileSelect && vtkFileSelect.value) {\n                selectedVtkFilePath = vtkFileSelect.value;\n            }\n        }\n\n        // Log for debugging\n        console.log('[FOAMFlask] [generateContours] Using case directory:', selectedCaseDir);\n        if (selectedVtkFilePath) {\n            console.log('[FOAMFlask] [generateContours] Using VTK file:', selectedVtkFilePath);\n        }\n\n        // Get range from input fields if not provided in options\n        let range = options.range;\n        if (!range) {\n            const rangeMinInput = document.getElementById('rangeMin') as MyHTMLElement | null;\n            const rangeMaxInput = document.getElementById('rangeMax') as MyHTMLElement | null;\n            const rangeMin = rangeMinInput?.value ? parseFloat(rangeMinInput.value) : null;\n            const rangeMax = rangeMaxInput?.value ? parseFloat(rangeMaxInput.value) : null;\n\n            if (\n                rangeMin !== null &&\n                rangeMax !== null &&\n                !isNaN(rangeMin) &&\n                !isNaN(rangeMax) &&\n                rangeMin < rangeMax\n            ) {\n                range = [rangeMin, rangeMax];\n                console.log('[FOAMFlask] [generateContours] Using range from input fields:', range);\n            }\n        }\n\n        console.log('[FOAMFlask] [generateContours] Request parameters:', {\n            tutorial: selectedTutorial,\n            caseDir: selectedCaseDir,\n            scalarField,\n            numIsosurfaces,\n            colorMap,\n            range,\n            vtkFilePath: selectedVtkFilePath\n        });\n\n        // Get showIsovalueWidget from checkbox\n        const showIsovalueWidgetCheckbox = document.getElementById('showIsovalueWidget') as HTMLInputElement | null;\n        const showIsovalueWidget = showIsovalueWidgetCheckbox ? showIsovalueWidgetCheckbox.checked : false;\n\n        // Toggle slider visibility\n        const sliderContainer = document.getElementById('isovalueSliderContainer');\n        if (sliderContainer) {\n            if (showIsovalueWidget) {\n                sliderContainer.classList.remove('hidden');\n            } else {\n                sliderContainer.classList.add('hidden');\n            }\n        }\n\n        // Get slider value if enabled\n        let isovalues: number[] | undefined;\n        if (showIsovalueWidget) {\n            const slider = document.getElementById('isovalueSlider') as HTMLInputElement;\n            if (slider) {\n                isovalues = [parseFloat(slider.value)];\n            }\n        }\n\n        // Prepare request data\n        const requestData: ContourOptions = {\n            tutorial: selectedTutorial,\n            caseDir: selectedCaseDir,\n            scalarField,\n            numIsosurfaces,\n            vtkFilePath: selectedVtkFilePath,\n            showIsovalueWidget,\n            isovalues,\n            colorMap\n        };\n\n        if (range && Array.isArray(range) && range.length === 2) {\n            requestData.range = range;\n            console.log('[FOAMFlask] [generateContours] Using range:', range);\n        }\n\n        console.log('[FOAMFlask] [generateContours] Request data with range:', requestData);\n\n        // API request (send as POST body)\n        console.log('[FOAMFlask] [generateContours] Calling fetchContours...');\n        const response = await fetchContours(requestData);\n\n        // Await the response JSON\n        console.log('[FOAMFlask] [generateContours] Reading response content...');\n        const vizInfo = await response.json();\n        console.log('[FOAMFlask] [generateContours] Received visualization info:', vizInfo);\n\n        // Display the visualization\n        displayContourVisualization(contourViewer, vizInfo);\n\n        // Store current data for export\n        currentContourData = {\n            tutorial: selectedTutorial,\n            caseDir: selectedCaseDir,\n            scalarField,\n            numIsosurfaces,\n            timestamp: new Date().toISOString(),\n            vtkFilePath: selectedVtkFilePath || undefined,\n            colorMap\n        };\n\n        console.log('[FOAMFlask] [generateContours] Contours generated successfully!');\n\n        if (typeof showNotification === 'function') {\n            showNotification('Contours generated successfully!', 'success');\n        }\n\n    } catch (error: unknown) {\n        console.error('[FOAMFlask] [generateContours] Error:', error);\n        handleContourError(contourPlaceholder, contourViewer, error);\n    } finally {\n        if (btn) {\n            btn.disabled = false;\n            btn.removeAttribute(\"aria-busy\");\n            btn.innerHTML = originalText;\n        }\n    }\n}\n\n/**\n * Load mesh metadata for contour configuration\n * @param vtkFilePath - Path to the VTK file\n */\nexport async function loadContourMesh(vtkFilePath: string): Promise<void> {\n    if (!vtkFilePath) {\n        if (typeof showNotification === 'function') {\n            showNotification(\"Please select a VTK file first.\", \"warning\");\n        }\n        return;\n    }\n\n    try {\n        console.log(\"[FOAMFlask] [loadContourMesh] Loading mesh for contour:\", vtkFilePath);\n\n        // Show loading notification\n        if (typeof showNotification === 'function') {\n            showNotification(\"Loading mesh metadata...\", \"info\", 1000);\n        }\n\n        const response = await fetch('/api/load_mesh', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n                file_path: vtkFilePath,\n                for_contour: true\n            })\n        });\n\n        if (!response.ok) {\n            const errorText = await response.text();\n            throw new Error(`Server returned ${response.status}: ${errorText}`);\n        }\n\n        const meshInfo = await response.json();\n        console.log(\"[FOAMFlask] [loadContourMesh] Mesh info loaded:\", meshInfo);\n\n        if (meshInfo.error) {\n            throw new Error(meshInfo.error);\n        }\n\n        // Store field stats for auto-ranging\n        if (meshInfo.field_stats) {\n            currentFieldStats = meshInfo.field_stats;\n        }\n\n        // Populate Scalar Fields\n        const scalarFieldSelect = document.getElementById('scalarField') as HTMLSelectElement | null;\n        if (scalarFieldSelect && meshInfo.point_arrays) {\n            scalarFieldSelect.innerHTML = ''; // Clear existing\n\n            // Add options\n            meshInfo.point_arrays.forEach((field: string) => {\n                const option = document.createElement('option');\n                option.value = field;\n                option.textContent = field;\n                option.classList.add('point-data-option'); // Add styling class\n                scalarFieldSelect.appendChild(option);\n            });\n\n            // If U_Magnitude exists, select it by default, otherwise select first\n            if (meshInfo.point_arrays.includes('U_Magnitude')) {\n                scalarFieldSelect.value = 'U_Magnitude';\n            } else if (meshInfo.point_arrays.length > 0) {\n                scalarFieldSelect.value = meshInfo.point_arrays[0];\n            }\n\n            // Setup listeners and update ranges for the initial selection\n            setupScalarFieldListeners();\n            updateRangeInputs(scalarFieldSelect.value);\n        }\n\n        // Populate Info Box\n        const contourInfo = document.getElementById('contourInfo');\n        const contourInfoContent = document.getElementById('contourInfoContent');\n        if (contourInfo && contourInfoContent) {\n            contourInfo.classList.remove('hidden');\n            contourInfoContent.innerHTML = `\n                <div><span class=\"font-semibold\">Points:</span> ${meshInfo.n_points}</div>\n                <div><span class=\"font-semibold\">Cells:</span> ${meshInfo.n_cells}</div>\n                <div class=\"col-span-2\"><span class=\"font-semibold\">Fields:</span> ${meshInfo.point_arrays ? meshInfo.point_arrays.length : 0}</div>\n            `;\n        }\n\n        if (typeof showNotification === 'function') {\n            showNotification(\"Mesh loaded for contour configuration!\", \"success\");\n        }\n\n        // Optionally clear ranges to suggest \"Auto\" or just leave them\n        // For now, let's not aggressively clear them unless requested\n\n    } catch (error: unknown) {\n        console.error('[FOAMFlask] [loadContourMesh] Error:', error);\n        if (typeof showNotification === 'function') {\n            const message = error instanceof Error ? error.message : String(error);\n            showNotification(`Error loading mesh: ${message}`, 'error');\n        }\n    }\n}\n\n/**\n * Show loading state in the viewer\n */\nfunction showLoadingState(container: HTMLElement | null, message = 'Loading...') {\n    if (!container) return;\n\n    container.innerHTML = `\n        <div class=\"flex items-center justify-center h-full\">\n            <div class=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cyan-600\"></div>\n            <span class=\"ml-4 text-gray-600\"></span>\n        </div>\n    `;\n\n    // Set message text safely\n    const messageSpan = container.querySelector('span');\n    if (messageSpan) {\n        messageSpan.textContent = message;\n    }\n}\n\n/**\n * Get selected tutorial from dropdown\n */\nfunction getTutorialFromSelect(): string | null {\n    const tutorialSelect = document.getElementById('tutorialSelect') as MyHTMLElement | null;\n    return tutorialSelect ? tutorialSelect.value : null;\n}\n\n/**\n * Fetch contours from the server\n * Send all data in the request body to avoid URL encoding issues with Windows paths\n */\nasync function fetchContours(requestData: ContourOptions) {\n    const url = new URL('/api/contours/create', window.location.origin);\n\n    console.log('[FOAMFlask] [fetchContours] URL:', url.toString());\n    console.log('[FOAMFlask] [fetchContours] Origin:', window.location.origin);\n    console.log('[FOAMFlask] [fetchContours] Request data:', requestData);\n\n    // Prepare the request body\n    const requestBody: {\n        tutorial?: string | null;\n        caseDir?: string | { value: string } | null;\n        scalar_field?: string;\n        num_isosurfaces?: number;\n        range?: [number, number];\n        vtkFilePath?: string | null;\n        showIsovalueWidget?: boolean;\n        isovalues?: number[];\n        colormap?: string;\n    } = {\n        tutorial: requestData.tutorial,\n        caseDir: requestData.caseDir,\n        scalar_field: requestData.scalarField,\n        num_isosurfaces: requestData.numIsosurfaces,\n        vtkFilePath: requestData.vtkFilePath,\n        showIsovalueWidget: requestData.showIsovalueWidget,\n        isovalues: requestData.isovalues,\n        colormap: requestData.colorMap // Map frontend camelCase to backend snake_case\n    };\n\n    if (requestData.range && Array.isArray(requestData.range) && requestData.range.length === 2) {\n        requestBody.range = requestData.range;\n        console.log('[FOAMFlask] [fetchContours] Including range in request:', requestData.range);\n    }\n\n    const body = JSON.stringify(requestBody);\n\n    try {\n        console.log('[FOAMFlask] [fetchContours] Sending fetch request...');\n\n        const response = await fetch(url.toString(), {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n                'Accept': 'text/html, application/xhtml+xml'\n            },\n            body,\n            mode: 'cors',\n            credentials: 'same-origin'\n        });\n\n        console.log('[FOAMFlask] [fetchContours] Response received');\n        console.log('[FOAMFlask] [fetchContours] Status:', response.status);\n        console.log('[FOAMFlask] [fetchContours] Status text:', response.statusText);\n        console.log('[FOAMFlask] [fetchContours] Content-Type:', response.headers.get('Content-Type'));\n\n        if (!response.ok) {\n            const errorText = await response.text();\n            console.error('[FOAMFlask] [fetchContours] Error response:', errorText);\n            throw new Error(`Server returned ${response.status}: ${errorText}`);\n        }\n\n        return response;\n\n    } catch (error: unknown) {\n        console.error('[FOAMFlask] [fetchContours] Fetch failed:', error);\n\n        if (error instanceof Error && error.message.includes('Failed to fetch')) {\n            console.error('[FOAMFlask] [fetchContours] Network error details:');\n            console.error('  - Server URL:', url.toString());\n            console.error('  - Your page origin:', window.location.origin);\n            console.error('  - Check if Flask server is running on that address');\n        }\n\n        throw error;\n    }\n}\n\n/**\n * Display the contour visualization in the viewer\n */\nfunction displayContourVisualization(container: HTMLElement | null, content: any) {\n    if (!container) {\n        console.error('[FOAMFlask] [displayContourVisualization] Container not found');\n        return;\n    }\n\n    try {\n        // Clear the container first\n        container.innerHTML = '';\n\n        // Create an iframe to contain the visualization\n        const iframe = document.createElement('iframe');\n        iframe.id = 'contourVisualizationFrame';\n        iframe.setAttribute('scrolling', 'no'); // Legacy attribute, still useful\n        iframe.style.cssText = `\n            width: 100%;\n            height: 600px;\n            border: none;\n            border-radius: 0.5rem;\n            box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            background: white;\n            overflow: hidden; /* Ensure iframe container doesn't scroll */\n        `;\n\n        // Handle Trame URL\n        if (content.mode === 'iframe' && content.src) {\n            // Append timestamp to force reload/prevent caching\n            const url = new URL(content.src);\n            url.searchParams.set('t', Date.now().toString());\n            const finalUrl = url.toString();\n\n            console.log('[FOAMFlask] [displayContourVisualization] Embedding Trame URL:', finalUrl);\n            iframe.src = finalUrl;\n        } else {\n            console.warn('[FOAMFlask] [displayContourVisualization] Unexpected content format', content);\n            container.innerHTML = `\n                <div class=\"p-4 text-red-600 bg-red-50 rounded-lg\">\n                    <h3 class=\"font-semibold\">Error displaying visualization</h3>\n                    <p class=\"text-sm mt-1\">Received unexpected response format representing from server.</p>\n                </div>\n            `;\n            return;\n        }\n\n        container.appendChild(iframe);\n\n        setTimeout(() => {\n            window.dispatchEvent(new Event('resize'));\n        }, 500);\n\n    } catch (error) {\n        console.error('[FOAMFlask] [displayContourVisualization] Error:', error);\n        if (container) {\n            const message = error instanceof Error ? error.message : 'Unknown error occurred';\n            container.innerHTML = `\n                <div class=\"p-4 text-red-600 bg-red-50 rounded-lg\">\n                    <h3 class=\"font-semibold\">Error displaying visualization</h3>\n                    <p class=\"text-sm mt-1\">${message}</p>\n                </div>\n            `;\n        }\n    }\n}\n\n\n\n/**\n * Handle errors during contour generation\n */\nfunction handleContourError(\n    placeholder: HTMLElement | null,\n    viewer: HTMLElement | null,\n    error: unknown\n) {\n    if (placeholder) placeholder.classList.remove('hidden');\n    if (viewer) viewer.classList.add('hidden');\n\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';\n\n    if (typeof showNotification === 'function') {\n        // Sanitize message to avoid selector errors if it contains quotes\n        const safeMessage = errorMessage.replace(/[\"']/g, '');\n        showNotification(`Error generating contours: ${safeMessage}`, 'error');\n    }\n\n    if (viewer) {\n        viewer.innerHTML = `\n            <div class=\"p-8 text-center\">\n                <div class=\"text-red-600 text-lg font-semibold mb-4\">\n                    ⚠️ Error Generating Contours\n                </div>\n                <div class=\"text-gray-600 mb-4\"></div>\n                <div class=\"text-sm text-gray-500 mt-4 p-4 bg-gray-50 rounded\">\n                    <p><strong>Troubleshooting:</strong></p>\n                    <ul class=\"text-left mt-2\">\n                        <li>✓ Ensure you've selected a tutorial in the Setup page</li>\n                        <li>✓ Ensure the case directory is set correctly</li>\n                        <li>✓ Ensure you've run 'foamToVTK' to generate VTK files</li>\n                        <li>✓ Check the browser console for more details</li>\n                        <li>✓ Check the Flask server logs for backend errors</li>\n                    </ul>\n                </div>\n                <button \n                    onclick=\"generateContours()\" \n                    class=\"mt-4 px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700\">\n                    Try Again\n                </button>\n            </div>\n        `;\n\n        // Set error message safely\n        const errorDiv = viewer.querySelector('.text-gray-600.mb-4');\n        if (errorDiv) {\n            errorDiv.textContent = errorMessage;\n        }\n    }\n}\n\n/**\n * Generate contours with custom parameters from UI controls\n */\nexport async function generateContoursWithParams() {\n    try {\n        const scalarFieldSelect = document.getElementById('scalarField') as MyHTMLElement | null;\n        const numIsosurfacesInput = document.getElementById('numIsosurfaces') as MyHTMLElement | null;\n\n        const scalarField = scalarFieldSelect?.value || 'U_Magnitude';\n        const numIsosurfaces = numIsosurfacesInput?.value ? parseInt(numIsosurfacesInput.value, 10) : 5;\n\n        // Get tutorial from select (same logic as generateContours)\n        const selectedTutorial = getTutorialFromSelect() ?? '';\n        if (!selectedTutorial) {\n            if (typeof showNotification === 'function') {\n                showNotification('Please select a tutorial first', 'warning');\n            }\n            return;\n        }\n\n        // Get case directory from input field (same logic as generateContours)\n        const caseDirInput = document.getElementById('caseDir') as MyHTMLElement | null;\n        const selectedCaseDir = caseDirInput?.value || '';\n        if (!selectedCaseDir) {\n            if (typeof showNotification === 'function') {\n                showNotification('Case directory not set. Please set it in the Setup page.', 'warning');\n            }\n            return;\n        }\n\n        console.log('[FOAMFlask] [generateContoursWithParams] Generating contours with parameters:', {\n            tutorial: selectedTutorial,\n            caseDir: selectedCaseDir,\n            scalarField,\n            numIsosurfaces\n        });\n\n        // Pass all required properties with real values\n        await generateContours({\n            tutorial: selectedTutorial,\n            caseDir: selectedCaseDir,\n            scalarField,\n            numIsosurfaces,\n            colorMap: (document.getElementById('colorMap') as MyHTMLElement)?.value\n        });\n    } catch (error: unknown) {\n        if (typeof showNotification === 'function') {\n            const message = error instanceof Error ? error.message : String(error);\n            showNotification(`Error: ${message}`, 'error');\n        }\n    }\n}\n\n/**\n * Download contour visualization as image\n */\nexport function downloadContourImage() {\n    if (!currentContourData) {\n        if (typeof showNotification === 'function') {\n            showNotification('No contour visualization available to download', 'warning');\n        }\n        return;\n    }\n\n    const contourViewer = document.getElementById('contourViewer');\n    const iframe = document.getElementById('contourVisualizationFrame') as HTMLIFrameElement | null;\n    if (!contourViewer || !iframe || !iframe.contentDocument) return;\n\n    const canvas = iframe.contentDocument.querySelector('canvas');\n    if (!canvas) {\n        if (typeof showNotification === 'function') {\n            showNotification('Cannot download: visualization not rendered as canvas', 'error');\n        }\n        return;\n    }\n\n    try {\n        canvas.toBlob((blob: Blob | null) => {\n            if (!blob) {\n                if (typeof showNotification === 'function') {\n                    showNotification('Failed to create image blob', 'error');\n                }\n                return;\n            }\n\n            const url = URL.createObjectURL(blob);\n            const link = document.createElement('a');\n            link.href = url;\n            // Null check before accessing scalarField\n            link.download = `contour_${currentContourData?.scalarField || 'unknown'}_${Date.now()}.png`;\n            document.body.appendChild(link);\n            link.click();\n            document.body.removeChild(link);\n            URL.revokeObjectURL(url);\n\n            if (typeof showNotification === 'function') {\n                showNotification('Contour image downloaded successfully', 'success');\n            }\n        });\n    } catch (error: unknown) {\n        if (typeof showNotification === 'function') {\n            showNotification('Failed to download contour image', 'error');\n        }\n    }\n}\n\n/**\n * Export contour data as JSON\n */\nexport function exportContourData() {\n    if (!currentContourData) {\n        if (typeof showNotification === 'function') {\n            showNotification('No contour data available to export', 'warning');\n        }\n        return;\n    }\n\n    const dataStr = JSON.stringify(currentContourData, null, 2);\n    const blob = new Blob([dataStr], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `contour_data_${Date.now()}.json`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n\n    if (typeof showNotification === 'function') {\n        showNotification('Contour data exported successfully', 'success');\n    }\n}\n\n/**\n * Reset contour viewer to initial state\n */\nexport function resetContourViewer() {\n    const contourPlaceholder = document.getElementById('contourPlaceholder');\n    const contourViewer = document.getElementById('contourViewer');\n\n    if (contourPlaceholder) contourPlaceholder.classList.remove('hidden');\n    if (contourViewer) {\n        contourViewer.classList.add('hidden');\n        contourViewer.innerHTML = '';\n    }\n\n    currentContourData = null;\n}\n\n/**\n * Update UI range controls and the isovalue slider using stored statistics for the given scalar field.\n * Updates the numeric min/max inputs, the formatted displayMin/displayMax text, reveals the scalar range card,\n * and sets the isovalue slider's min, max, step, value, and display text when statistics for `fieldName` exist.\n * @param fieldName - The scalar field key to read statistics from `currentFieldStats`; no action is taken if stats are missing\n */\nfunction updateRangeInputs(fieldName: string): void {\n    if (!currentFieldStats || !currentFieldStats[fieldName]) return;\n\n    const stats = currentFieldStats[fieldName];\n    // Handle both vector (magnitude_stats) and scalar (direct stats)\n    const min = stats.type === 'vector' ? stats.magnitude_stats?.min : stats.min;\n    const max = stats.type === 'vector' ? stats.magnitude_stats?.max : stats.max;\n\n    if (min !== undefined && max !== undefined) {\n        const minInput = document.getElementById('rangeMin') as HTMLInputElement;\n        const maxInput = document.getElementById('rangeMax') as HTMLInputElement;\n        const displayMin = document.getElementById('displayMin');\n        const displayMax = document.getElementById('displayMax');\n        const scalarRangeCard = document.getElementById('scalarRangeCard');\n\n        if (minInput) minInput.value = min.toString();\n        if (maxInput) maxInput.value = max.toString();\n        if (displayMin) displayMin.textContent = parseFloat(min).toFixed(4);\n        if (displayMax) displayMax.textContent = parseFloat(max).toFixed(4);\n        if (scalarRangeCard) scalarRangeCard.classList.remove('hidden');\n\n        // Update slider as well\n        const slider = document.getElementById('isovalueSlider') as HTMLInputElement;\n        const display = document.getElementById('isovalueDisplay');\n\n        if (slider) {\n            slider.min = min.toString();\n            slider.max = max.toString();\n            slider.step = ((max - min) / 100).toString();\n            // Keep relative position or reset to center? Reset to center for now.\n            slider.value = ((max + min) / 2).toString();\n            if (display) display.textContent = parseFloat(slider.value).toFixed(2);\n        }\n    }\n}\n\n/**\n * Reset range inputs to global min/max for current field\n */\n(window as any).resetScalarRange = (): void => {\n    const scalarFieldSelect = document.getElementById('scalarField') as HTMLSelectElement;\n    if (scalarFieldSelect && scalarFieldSelect.value) {\n        updateRangeInputs(scalarFieldSelect.value);\n        if (typeof showNotification === 'function') {\n            showNotification(\"Range reset to data bounds\", \"success\", 1500);\n        }\n    }\n};\n\n/**\n * Setup listeners for scalar field changes\n */\nfunction setupScalarFieldListeners(): void {\n    const scalarFieldSelect = document.getElementById('scalarField') as HTMLSelectElement;\n    if (scalarFieldSelect) {\n        // Remove old listener to avoid duplicates if called multiple times?\n        // Ideally we should use a named function or check if attached.\n        // For simplicity, we'll just set onchange (replacing old one)\n        scalarFieldSelect.onchange = () => {\n            updateRangeInputs(scalarFieldSelect.value);\n        };\n    }\n\n    // Also update slider display on input and sync with backend\n    const slider = document.getElementById('isovalueSlider') as HTMLInputElement | null;\n    const display = document.getElementById('isovalueDisplay');\n\n    if (slider && display) {\n        slider.oninput = () => {\n            const val = parseFloat(slider.value);\n            display.textContent = val.toFixed(2);\n\n            // Send update to Trame if active\n            const iframe = document.getElementById('contourVisualizationFrame') as HTMLIFrameElement | null;\n            if (iframe && iframe.contentWindow) {\n                iframe.contentWindow.postMessage({ type: 'set_isovalue', value: val }, '*');\n            }\n        };\n\n        slider.onchange = () => {\n            const val = parseFloat(slider.value);\n            display.textContent = val.toFixed(2);\n\n            // Final update on release\n            const iframe = document.getElementById('contourVisualizationFrame') as HTMLIFrameElement | null;\n            if (iframe && iframe.contentWindow) {\n                iframe.contentWindow.postMessage({ type: 'set_isovalue', value: val }, '*');\n            } else {\n                // Fallback to full regeneration if not interactive or iframe missing\n                // (Only if widget is checked and we are not in a synced state)\n                const checkbox = document.getElementById('showIsovalueWidget') as HTMLInputElement | null;\n                if (checkbox && checkbox.checked) {\n                    generateContours();\n                }\n            }\n        };\n    }\n}\n\n/**\n * Initialize the isovalue widget logic (event listeners)\n */\nexport function initIsovalueWidget(): void {\n    const showIsovalueWidgetCheckbox = document.getElementById('showIsovalueWidget') as HTMLInputElement | null;\n    const sliderContainer = document.getElementById('isovalueSliderContainer');\n\n    if (showIsovalueWidgetCheckbox && sliderContainer) {\n        // Initial state\n        if (showIsovalueWidgetCheckbox.checked) {\n            sliderContainer.classList.remove('hidden');\n        } else {\n            sliderContainer.classList.add('hidden');\n        }\n\n        // Event listener\n        showIsovalueWidgetCheckbox.addEventListener('change', () => {\n            if (showIsovalueWidgetCheckbox.checked) {\n                sliderContainer.classList.remove('hidden');\n            } else {\n                sliderContainer.classList.add('hidden');\n            }\n        });\n    }\n}\n\n// Initialize on load\n// Initialize when DOM is ready or immediately if already loaded\nif (typeof window !== 'undefined') {\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', initIsovalueWidget);\n    } else {\n        initIsovalueWidget();\n    }\n}\n"],"names":["currentContourData","currentFieldStats","generateContours","options","contourPlaceholder","document","getElementById","contourViewer","tutorial","caseDir","vtkFilePath","scalarField","numIsosurfaces","colorMap","btn","originalText","innerHTML","disabled","setAttribute","showLoadingState","classList","add","remove","undefined","scalarFieldSelect","value","numIsosurfacesInput","parseInt","colorMapSelect","selectedTutorial","getTutorialFromSelect","Error","selectedCaseDir","caseDirInput","String","trim","selectedVtkFilePath","vtkFileSelect","vtkFileBrowser","files","length","console","log","range","rangeMinInput","rangeMaxInput","rangeMin","parseFloat","rangeMax","isNaN","showIsovalueWidgetCheckbox","showIsovalueWidget","checked","sliderContainer","isovalues","slider","requestData","Array","isArray","response","fetchContours","vizInfo","json","displayContourVisualization","timestamp","Date","toISOString","showNotification","error","handleContourError","removeAttribute","loadContourMesh","fetch","method","headers","body","JSON","stringify","file_path","for_contour","ok","errorText","text","status","meshInfo","field_stats","point_arrays","forEach","field","option","createElement","textContent","appendChild","includes","setupScalarFieldListeners","updateRangeInputs","contourInfo","contourInfoContent","n_points","n_cells","message","container","messageSpan","querySelector","tutorialSelect","url","URL","window","location","origin","toString","requestBody","scalar_field","num_isosurfaces","colormap","mode","credentials","statusText","get","content","iframe","id","style","cssText","src","searchParams","set","now","finalUrl","warn","setTimeout","dispatchEvent","Event","placeholder","viewer","errorMessage","safeMessage","replace","errorDiv","generateContoursWithParams","downloadContourImage","contentDocument","canvas","toBlob","blob","createObjectURL","link","href","download","click","removeChild","revokeObjectURL","exportContourData","dataStr","Blob","type","resetContourViewer","fieldName","stats","min","magnitude_stats","max","minInput","maxInput","displayMin","displayMax","scalarRangeCard","toFixed","display","step","resetScalarRange","onchange","oninput","val","contentWindow","postMessage","checkbox","initIsovalueWidget","addEventListener","readyState"],"mappings":"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"}